name: API Testing and Validation

on:
  workflow_dispatch: 
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint-openapi-spec:
    name: Lint OpenAPI Specification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
      
      - name: Login to Postman CLI
        run: postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}
        continue-on-error: true
      
      - name: Lint OpenAPI Spec with Postman
        run: postman spec lint postman/specs/openapi.yaml --report-events
        continue-on-error: false

  run-postman-collection:
    name: Run Postman Collection Tests
    runs-on: ubuntu-latest
    needs: lint-openapi-spec
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Start Identity Service
        run: |
          npm start &
          echo $! > server.pid
          # Wait for server to be ready
          timeout 30 bash -c 'until curl -f http://localhost:3001/health; do sleep 1; done'
        env:
          NODE_ENV: test
      
      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
      
      - name: Login to Postman CLI
        run: postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}
        continue-on-error: true
      
      - name: Run Postman Collection
        run: |
          postman collection run "postman/collections/Identity Service API.postman_collection.json" \
            --env-var "baseUrl=http://localhost:3001" \
            --reporters cli,json \
            --reporter-json-export test-results.json \
            --report-events
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: postman-test-results
          path: test-results.json
          retention-days: 30
      
      - name: Stop Identity Service
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi
      
      - name: Display Test Summary
        if: always()
        run: |
          if [ -f test-results.json ]; then
            echo "## Postman Collection Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Tests completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View detailed results in the artifacts section." >> $GITHUB_STEP_SUMMARY
          fi
